#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <sys/mman.h>
#include <byteswap.h>

static uint8_t buf[] = {
    0x48, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x48, 0x31, 0xc9, 0x48, 0xf7, 0xd1, 
    0x30, 0xc0, 0xfc, 0xf2, 0xae, 0x48, 0xf7, 0xd1, 
    0x48, 0xff, 0xc9, 0x48, 0x89, 0xca, 0x48, 0xbe, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0xb8, 0x01, 0x00, 0x00, 0x00, 0x48, 0x89, 0xc7, 
    0x0f, 0x05, 0x48, 0x31, 0xff, 0xb8, 0x3c, 0x00, 
    0x00, 0x00, 0x0f, 0x05
};

int print(char* message){

	uint64_t *addr = (uint64_t*)&message;
	memcpy(buf + 0x02,(uint8_t*)addr,8);
	memcpy(buf + 0x20,(uint8_t*)addr,8);

	void *code = mmap(NULL, sizeof(buf), PROT_READ|PROT_WRITE, 
		MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
	
	if(code == MAP_FAILED) {
		fprintf(stderr, "mmap() failed\n");
		return -1;
	}

	memcpy(code, buf, sizeof(buf));

	if(mprotect(code, sizeof(buf), PROT_EXEC) < 0){
		fprintf(stderr, "mprotect failed to mark exec-only\n");
		return -1;
	}

	typedef int (*func_t)(void);
	((func_t)(uint64_t)code)();
	munmap(code, sizeof(buf));

	return 0;
}

int main(){

	print("Hello World!\n");

	return 0;
}
